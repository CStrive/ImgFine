<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ImgFIne</title>
</head>
<body>
    <input type="file" id="files">
    <p>文件名称：<span id="file-name"></span></p>
    <p>文件大小：<span id="file-size"></span></p>
    <div id="downImage"></div>
    <div class="btn-tool" style="margin-bottom: 1rem">
        <button onclick="changes(0)">还原</button>
        <button onclick="changes(1)">灰度</button>
        <button onclick="changes(2)">透明</button>
        <button onclick="changes(3)">去除红色</button>
        <button onclick="changes(4)">滤镜</button>
        <button onclick="changes(5)">模糊</button>
    </div>
    <div style="width:1000px;">
        <canvas id="imgContainer"></canvas>
    </div>
    <script>
        var canvas = document.querySelector("#imgContainer");
        var downBtn = document.querySelector("#downImage");
        var fileForm = document.getElementById("files");
        var fileName = document.getElementById("file-name");
        var fileSize = document.getElementById("file-size");
        var dataold = null;
        var ctx = canvas.getContext('2d');
        fileForm.onchange = function (e) {
            var files = this.files[0];
            fileName.innerHTML = files.name;
            fileSize.innerHTML = Size(files.size);
            //绘制
            var image = new Image();
            image.src = URL.createObjectURL(files);
            image.onload = function () {
                //canvas.width = 1000;
                var w = (image.width > 1000 ? image.width / 2 : image.width);
                var h = (image.height > 1000 ? image.height / 2 : image.height);
                canvas.width = w;
                canvas.height = h;
                ctx.clearRect( 0 , 0 , canvas.width , canvas.height );
                ctx.drawImage(image,0,0,w,h);
                dataold = ctx.getImageData(0,0,canvas.width,canvas.height);

            }

        }

        //download
        var triggerDown = document.createElement("a");
        triggerDown.innerHTML = "下载图像";
        triggerDown.href = canvas.toDataURL("image/png");
        triggerDown.download = Math.floor(Math.random() * 50) + ".png";
        downBtn.appendChild(triggerDown);

        function changes(e) {
            if (e === 0) {
                ctx.putImageData(dataold,0,0);
            }
            if (e === 1) {
               var pixel = ctx.getImageData(0,0,canvas.width,canvas.height);
               var data = pixel.data;
               for (var i =0,j = data.length; i < j; i+=4) {
                   var grey = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];
                   data[i] = grey;
                   data[i + 1] = grey;
                   data[i + 2] = grey;
               }
               ctx.putImageData(pixel,0,0);
            }
            if (e === 2) {
                var pixel = ctx.getImageData(0,0,canvas.width,canvas.height);
                var data = pixel.data;
                for (var i =0,j = data.length; i < j; i+=4) {
                    data[i + 3] = 128;
                }
                ctx.putImageData(pixel,0,0);
            }
            if (e === 3) {
                var pixel = ctx.getImageData(0,0,canvas.width,canvas.height);
                var data = pixel.data;
                for (var i =0,j = data.length; i < j; i+=4) {
                    data[i] = 0;
                }
                ctx.putImageData(pixel,0,0);
            }
            if (e === 4) {
                var pixel = ctx.getImageData(0,0,canvas.width,canvas.height);
                let kernel = [-1,-1,-1,
                    -1,8,-1,
                    -1,-1,-1];//边缘检测
                ctx.putImageData(convolutionMatrix(ctx.createImageData(pixel),pixel,kernel),0,0);
            }
            if (e === 5) {
                var pixel = ctx.getImageData(0,0,canvas.width,canvas.height);
                let kernel = [1,1,1,
                    1,0.7,-1,
                    -1,-1,-1];//blur
                ctx.putImageData(convolutionMatrix(ctx.createImageData(pixel),pixel,kernel),0,0);
            }
        }

        function convolutionMatrix(output, input, kernel) {
            let w = input.width, h = input.height;
            let iD = input.data, oD = output.data;
            for (let y = 1; y < h - 1; y += 1) {
                for (let x = 1; x < w - 1; x += 1) {
                    for (let c = 0; c < 3; c += 1) {
                        let i = (y * w + x) * 4 + c;
                        oD[i] = kernel[0] * iD[i - w * 4 - 4] +
                            kernel[1] * iD[i - w * 4] +
                            kernel[2] * iD[i - w * 4 + 4] +
                            kernel[3] * iD[i - 4] +
                            kernel[4] * iD[i] +
                            kernel[5] * iD[i + 4] +
                            kernel[6] * iD[i + w * 4 - 4] +
                            kernel[7] * iD[i + w * 4] +
                            kernel[8] * iD[i + w * 4 + 4];
                    }
                    oD[(y * w + x) * 4 + 3] = 255;
                }
            }
            return output;
        }

        function Size(number) {
            if(number < 1024) {
                return number + 'bytes';
            } else if(number >= 1024 && number < 1048576) {
                return (number/1024).toFixed(1) + 'KB';
            } else if(number >= 1048576) {
                return (number/1048576).toFixed(1) + 'MB';
            }
        }
    </script>

</body>
</html>
